<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Water Spinach - scalability</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href=".././theme/css/main.css" type="text/css"/>
    <link type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,900,400italic,700italic">
    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Water Spinach Atom Feed" />
    
    
    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <!--[if lte IE 7]>
        <link rel="stylesheet" type="text/css" media="all" href=".././css/ie.css"/>
        <script src=".././js/IE8.js" type="text/javascript"></script><![endif]-->

    <!--[if lt IE 7]>
         <link rel="stylesheet" type="text/css" media="all" href=".././css/ie6.css"/><![endif]-->

        
<script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34233563-1']);
    _gaq.push(['_trackPageview']);
    _gaq.push(['_gat._anonymizeIp']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>

        
  </head> 
  <body id="index" class="home">
    <!--
<a href="https://github.com/khuevu">

<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />

</a>
-->
    <!--Logo, site metadata and navigation menu-->
    <header id="side" class="body">
    <aside id="logo"><div><img src=".././theme/images/logo.jpg" width="210" height="140"/></div>
    <hgroup>
    <h1 id="title"><a href="../.">Water Spinach </a></h1>
    <h2>Enough to fill the stomach</h2>
    </hgroup>
    </aside>  
    <nav>
        <ul class="menu">
            
            <li ><a href=".././category/Blog.html">Blog</a></li>
            
            <li><a href=".././tags.html">Tags</a></li>
            <li><a href=".././archive.html">Archive</a></li>
            <li><a href=".././about.html">About</a></li>
        </ul>
    </nav>
    <div id="credit">
    Powered by <a href="http://pelican.notmyidea.org/">Pelican</a>
    </div>
    </header>
    <!-- Content Block -->
    
<section id="content" class="body">

<ol id="posts" class="hfeed" start="9">
  

    

    <li>
      <article class="entry">
        <header>
        <h1 class="entry-title"><a href=".././2012/10/07/spring-hibernate-mysqlreplication.html">Integrate Spring and Hibernate with MySQL master/slave database</a></h1>
        <abbr class="published" title="2012-10-07T00:00:00">
                Sun 07 October 2012
        </abbr>
        <!--<p>In <a href=".././category/Blog.html"><b>Blog</b></a></p>-->
        </header>

        <div class="entry-content">
          <p>In my previous <a href="../2012/10/06/mysql-replication.html">post</a>, we have setup one master and one slave MySQL database. If you write your application to interact with database using jdbc connector, it already has the <a href="http://dev.mysql.com/doc/refman/5.1/en/connector-j-reference-replication-connection.html">support for database replication</a>. Basically, you need to use <code>com.mysql.jdbc.ReplicationDriver</code> and change connection to <code>readOnly</code> when you want it to direct traffics to slave instances. What if your application interfaces with database through Hibernate API? Hibernate doesn't explicitly support the replication. Setting Hibernate or Spring's transactions to <code>readOnly</code> doesn't change the underlying jdbc connection to <code>readOnly</code>. </p>
<p>The first thing come to mind is to have two separate instances of <code>Datasource</code>, one which connection set to <code>readOnly</code> and one not; and have two Hibernate's <code>SessionFactory</code> contain each. However, this method changes your existing programming model. The second choice is to access the underlying jdbc connection of Hibernate's SessionFactory and switch it to <code>readOnly</code> when it is read operation. </p>
<p>Here we are going to use Spring's AspectJ API to implement this. With Spring AspectJ annotation, we can introduce the switching of connection <code>readOnly</code> with least amount of change on code.<br />
</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="codehilite"><pre><span class="o">...</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionInterceptor</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">SessionFactory</span> <span class="n">sessionFactory</span><span class="o">;</span>

    <span class="nd">@Around</span><span class="o">(</span><span class="s">&quot;@annotation=ReadOnlyConnection&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">proceed</span><span class="o">(</span><span class="n">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">();</span>
        <span class="n">ConnectionReadOnly</span> <span class="n">readOnlyWork</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConnectionReadOnly</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">session</span><span class="o">.</span><span class="na">doWork</span><span class="o">(</span><span class="n">readOnlyWork</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">readOnlyWork</span><span class="o">.</span><span class="na">switchBack</span><span class="o">();</span>
            <span class="n">session</span><span class="o">.</span><span class="na">doWork</span><span class="o">(</span><span class="n">readOnlyWork</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Next, define the <code>@ReadOnlyConnection</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">ReadOnlyConnection</span> <span class="o">{</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>The <code>ConnectionReadOnly</code> class implements <code>org.hibernate.jdbc.Work</code> interface.<br />
</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionReadOnly</span> <span class="kd">implements</span> <span class="n">Work</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Connection</span> <span class="n">connection</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setReadOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">...</span>

    <span class="o">}</span>

    <span class="c1">//method to restore the connection state before intercepted</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">switchBack</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span> 
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>To enable AspectJ annotation in Spring, you need to add to spring context config file: </p>
<div class="codehilite"><pre><span class="nt">&lt;aop:aspectj-autoproxy/&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;connectionInterceptor&quot;</span> <span class="na">class=</span><span class="s">&quot;com.x.y.z.ConnectionInterceptor&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>


<p>So for any <code>ReadOnly</code> method at your DAO layer, you just need to add the <code>@ReadOnlyConnection</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomeDaoImpl</span> <span class="kd">implements</span> <span class="n">SomeDao</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">SessionFactory</span> <span class="n">sessionFactory</span><span class="o">;</span>
    <span class="o">...</span>

    <span class="nd">@ReadOnlyConnection</span>
    <span class="kd">public</span> <span class="n">Some</span> <span class="nf">get</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">();</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>In case you don't want to use annotation, you can use Spring's xml configuration. For the above example, we will have: </p>
<div class="codehilite"><pre><span class="nt">&lt;aop:config&gt;</span>
    <span class="nt">&lt;aop:aspect</span> <span class="na">id=</span><span class="s">&quot;connectionAspect&quot;</span> <span class="na">ref=</span><span class="s">&quot;connectionInterceptor&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&quot;connPointCut&quot;</span> <span class="na">expression=</span><span class="s">&quot;execution(* com.x.y.SomeDaoImpl.get(..))&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:around</span> <span class="na">method=</span><span class="s">&quot;proceed&quot;</span> <span class="na">pointcut-ref=</span><span class="s">&quot;connPointCut&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/aop:aspect&gt;</span>
<span class="nt">&lt;/aop:config&gt;</span>
</pre></div>
        </div>

        <footer>
          <div class="post-info">
<p>Tags: &nbsp;<a href=".././tag/java.html">java</a>&nbsp;&nbsp;<a href=".././tag/spring.html">spring</a>&nbsp;&nbsp;<a href=".././tag/hibernate.html">hibernate</a>&nbsp;&nbsp;<a href=".././tag/mysql.html">mysql</a>&nbsp;&nbsp;<a href=".././tag/scalability.html">scalability</a>&nbsp;&nbsp;</p>

</div><!-- /.post-info -->
          <!--
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="khuevu">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
-->
          <p><a href=".././2012/10/07/spring-hibernate-mysqlreplication.html#disqus_thread">Comments</a>.</p>
        </footer>
      </article>
    </li>

    
    
  

    

    <li>
      <article class="entry">

      <header> 
      <h1 class="entry-title"><a href=".././2012/10/06/mysql-replication.html">A Tutorial to set up MySQL replication (master/slave) for high scalability</a></h1>
        <abbr class="published" title="2012-10-06T00:00:00">
                Sat 06 October 2012
        </abbr>
        <!--<p>In <a href=".././category/Blog.html"><b>Blog</b></a></p>-->
      </header>

      <div class="entry-content">
        <p>In this tutorial, we will set up two instances of MySQL on your localhost, one master and one slave and enable data replication between the master and the slave.</p>
<p>There are several options when you want to scale horizontally with a MySQL database including database sharding, using MySQL Cluster with ...</p>
        <p class="readmore">
        <a href=".././2012/10/06/mysql-replication.html"><b>Read more</b></a>
        </p>
      </div>

      <footer>

      </footer>
      </article>
    </li>
    
    
  
  </ol>
  
<p class="paginator">
  
  
</p>



</section>

    <footer id="footer" class="body">
      <address id="about">
      </address>
    </footer>
    
<script type="text/javascript">
    var disqus_shortname = 'waterspinach';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

  </body>
</html>