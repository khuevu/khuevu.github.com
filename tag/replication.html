<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Water Spinach - replication</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href=".././theme/css/main.css" type="text/css"/>
    <link href="/" type="application/atom+xml" rel="alternate" title="Water Spinach Atom Feed" />
    
    
    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <!--[if lte IE 7]>
        <link rel="stylesheet" type="text/css" media="all" href=".././css/ie.css"/>
        <script src=".././js/IE8.js" type="text/javascript"></script><![endif]-->

    <!--[if lt IE 7]>
         <link rel="stylesheet" type="text/css" media="all" href=".././css/ie6.css"/><![endif]-->

        
<script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34233563-1']);
    _gaq.push(['_trackPageview']);
    _gaq.push(['_gat._anonymizeIp']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>

        
  </head> 
  <body id="index" class="home">
    
<a href="https://github.com/khuevu">

<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />

</a>

    <!--Logo, site metadata and navigation menu-->
    <header id="side" class="body">
    <aside id="logo"><div><img src=".././theme/images/logo.jpg" width="210" height="140"/></div>
    <hgroup>
    <h1 id="title"><a href="../.">Water Spinach </a></h1>
    <h2>Enough to fill the stomach</h2>
    </hgroup>
    </aside>  
    <nav>
        <ul class="menu">
            
            <li ><a href=".././category/Blog.html">Blog</a></li>
            
            <li><a href=".././tags.html">Tags</a></li>
            <li><a href=".././archive.html">Archive</a></li>
            <li><a href=".././about.html">About</a></li>
        </ul>
    </nav>
    <div id="credit">
    Powered by <a href="http://pelican.notmyidea.org/">Pelican</a>
    </div>
    </header>
    <!-- Content Block -->
    
<section id="content" class="body">

<ol id="posts" class="hfeed" start="9">
  
    <li>
      <article class="entry">
        <header>
        <h1 class="entry-title"><a href=".././2012/10/06/mysql-replication.html">A Tutorial to set up MySQL replication (master/slave) for high scalability</a></h1>
        <abbr class="published" title="2012-10-06T00:00:00">
                Sat 06 October 2012
        </abbr>
        <p>In <a href=".././category/Blog.html"><b>Blog</b></a></p>
        </header>
        <div class="entry-content">
          <p>In this tutorial, we will set up two instances of MySQL on your localhost, one master and one slave and enable data replication between the master and the slave.</p>
<p>There are several options when you want to scale horizontally with a MySQL database including database sharding, using MySQL Cluster with NDB storage or a master/slave setup. You can refer to this <a href="http://www.oshyn.com/_blog/General/post/A_Summary_of_Scaling_Options_for_MySQL/">link</a> for a more detailed summary. Master/slave will be suitable for your application if it performs a lot of read operations rather than write. So distributing the read operations accross multiple instance will help reduce the load on one master instance and enables scaling out. </p>
<h3>Configuration</h3>
<p>If you haven't had MySQL, download it from <a href="http://www.mysql.com/downloads/mysql/">here</a>, untar it and extract to a folder of your choice. Add the <code>bin</code> folder to your <code>PATH</code> if you don't want to specify the full path when invoking the process.<br />
</p>
<p>Create the folder for config files and data of master and slave instances:</p>
<div class="codehilite"><pre>$<span class="n">mkdir</span> <span class="o">-</span><span class="n">vp</span> <span class="o">~/</span><span class="n">replication</span><span class="o">/</span><span class="p">{</span><span class="n">master</span><span class="p">,</span><span class="n">slave</span><span class="p">}</span><span class="o">/</span><span class="p">{</span><span class="n">conf</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="nb">log</span><span class="p">}</span>
</pre></div>


<p>Run <code>mysql_install_db</code> script to populate the require <code>mysql</code> schema for each instance: </p>
<div class="codehilite"><pre>$<span class="n">scripts</span><span class="o">/</span><span class="n">mysql_install_db</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">defaults</span> <span class="o">--</span><span class="n">datadir</span><span class="p">=</span><span class="o">~/</span><span class="n">replication</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">data</span>
$<span class="n">scripts</span><span class="o">/</span><span class="n">mysql_install_db</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">defaults</span> <span class="o">--</span><span class="n">datadir</span><span class="p">=</span><span class="o">~/</span><span class="n">replication</span><span class="o">/</span><span class="n">slave</span><span class="o">/</span><span class="n">data</span>
</pre></div>


<p>Configure master instance: In <code>~/replication/master/conf/</code>, create <code>my.cnf</code>:</p>
<div class="codehilite"><pre><span class="c"># master my.cnf</span>

<span class="p">[</span><span class="n">client</span><span class="p">]</span> 
<span class="n">port</span>    <span class="p">=</span>   3306
<span class="n">socket</span>  <span class="p">=</span>   <span class="o">~/</span><span class="n">replication</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">mysqld</span><span class="p">.</span><span class="n">sock</span>

<span class="p">[</span><span class="n">mysqld</span><span class="p">]</span>
<span class="n">socket</span>  <span class="p">=</span>   <span class="o">~/</span><span class="n">replication</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">mysqld</span><span class="p">.</span><span class="n">sock</span>
<span class="n">port</span>    <span class="p">=</span>   3306
<span class="n">datadir</span> <span class="p">=</span>   <span class="o">~/</span><span class="n">replication</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">data</span>
<span class="c">#basedir: location of your MySQL installation</span>
<span class="n">basedir</span> <span class="p">=</span>   <span class="p">...</span> 
<span class="p">...</span>
</pre></div>


<p>Next, start the master instance using the command: </p>
<div class="codehilite"><pre>$<span class="n">mysqld</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="p">=</span><span class="o">~/</span><span class="n">replication</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
</pre></div>


<p>Create <code>replicatedb</code>, after log in using mysql client: </p>
<div class="codehilite"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">CREATE</span> <span class="n">SCHEMA</span> `<span class="n">replicatedb</span>`<span class="p">;</span>
</pre></div>


<p>Populate some table and data for your schema. Next we need to tell the server to use binary log to log change made to this schema. Add the following lines to the <code>my.cnf</code> file, under server section: </p>
<div class="codehilite"><pre><span class="nb">log</span><span class="o">-</span><span class="n">bin</span> <span class="p">=</span>   <span class="o">~/</span><span class="n">replication</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="p">.</span><span class="nb">log</span>
<span class="n">binlog</span><span class="o">-</span><span class="n">do</span><span class="o">-</span><span class="n">db</span>    <span class="p">=</span>   <span class="n">replicatedb</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span>   <span class="p">=</span>   1
</pre></div>


<p>Note that the server-id must be unique between master and slaves. If you want replication for multiple schema, use multiple <code>binlog-do-db</code> option. Restart the server.</p>
<h3>Create user for replication:</h3>
<p>Next create the user which has the <code>REPLICATION SLAVE</code> permission, which slave instances will use to access master data. In mysql client command: </p>
<div class="codehilite"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">CREATE</span> <span class="n">USER</span> <span class="s">&#39;slave&#39;</span><span class="p">@</span><span class="s">&#39;127.0.0.1&#39;</span> <span class="n">IDENTIFIED</span> <span class="n">BY</span> `<span class="n">slave</span>`<span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">GRANT</span> <span class="n">REPLICATION</span> <span class="n">SLAVE</span> <span class="n">ON</span> <span class="o">*.*</span> <span class="n">TO</span> <span class="s">&#39;slave&#39;</span><span class="p">@</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">;</span>
</pre></div>


<h3>Obtain replication point</h3>
<p>Still in the mysql client console: </p>
<div class="codehilite"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="n">TABLES</span> <span class="n">WITH</span> <span class="n">READ</span> <span class="n">LOCK</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">MASTER</span> <span class="n">STATUS</span><span class="p">;</span>
</pre></div>


<p>Output: </p>
<div class="codehilite"><pre><span class="o">+------------------+----------+------------------+------------------+</span>
<span class="o">|</span> <span class="n">File</span>             <span class="o">|</span> <span class="n">Position</span> <span class="o">|</span> <span class="n">Binlog_Do_DB</span>     <span class="o">|</span> <span class="n">Binlog_Ignore_DB</span> <span class="o">|</span>
<span class="o">+------------------+----------+------------------+------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="p">.</span>000016 <span class="o">|</span>      106 <span class="o">|</span> <span class="n">replicatedb</span>      <span class="o">|</span>                  <span class="o">|</span>
<span class="o">+------------------+----------+------------------+------------------+</span>
</pre></div>


<p>The above commands will lock the master database, preventing any writes to it, and output the current coordinate of binary log. Then we will dump a database snapshot of the master and restore it to the slave instance. If we don't look the database, and new change made to it, there will be inconsistence between the master's data and the snapshot, which leads to a corrupted databases on the slave. </p>
<div class="codehilite"><pre>$<span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="n">replicatedb</span> <span class="o">&gt;</span> <span class="n">replicatedb</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<h3>Setup slave instance</h3>
<p>To setup the slave, instance, create a similar configure file as master instance and change the port number to 3307. Enable <code>binlog</code> for slave instance if you want it later to serve as the master to other slave instances (which help reduces the sync requests to a single master). And add the following lines:</p>
<div class="codehilite"><pre><span class="k">[mysqld]</span>
<span class="err">...</span>
<span class="na">server-id</span>   <span class="o">=</span>   <span class="s">2</span>
<span class="na">replicate-do-db</span> <span class="o">=</span>   <span class="s">replicatedb</span>
</pre></div>


<p>Start slave instance: </p>
<div class="codehilite"><pre>$<span class="n">mysqld</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="p">=</span><span class="o">~/</span><span class="n">replication</span><span class="o">/</span><span class="n">slave</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
</pre></div>


<p>Restore the dumped file: </p>
<div class="codehilite"><pre>$<span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">h</span> &quot;127<span class="p">.</span>0<span class="p">.</span>0<span class="p">.</span>1&quot; <span class="o">-</span><span class="n">P</span> 3307 <span class="n">replicatedb</span> <span class="o">&lt;</span> <span class="n">replicatedb</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<p>After you has restore the dumped data to slave instance, unlock the table in master instance:</p>
<div class="codehilite"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">UNLOCK</span> <span class="n">TABLES</span><span class="p">;</span>
</pre></div>


<p>Then we need to tell the slave instance the username and password it is going to use for replication, the coordinate of the bin log file. Login to slave instance using mysql client, type in the following commands:</p>
<div class="codehilite"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">STOP</span> <span class="n">SLAVE</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span>
        <span class="n">MASTER_HOST</span><span class="p">=</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span>
        <span class="n">MASTER_USER</span><span class="p">=</span><span class="s">&#39;slave&#39;</span><span class="p">,</span>
        <span class="n">MASTER_PASSWORD</span><span class="p">=</span><span class="s">&#39;slave&#39;</span><span class="p">,</span>
        <span class="n">MASTER_PORT</span><span class="p">=</span>3306<span class="p">,</span>
        <span class="n">MASTER_LOG_FILE</span><span class="p">=</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="p">.</span>000016<span class="p">,</span>
        <span class="n">MASTER_LOG_POS</span><span class="p">=</span>106<span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">START</span> <span class="n">SLAVE</span><span class="p">;</span>
</pre></div>
        </div>
        <footer>
          <div class="post-info">
<p>Tags: &nbsp;<a href=".././tag/mysql.html">mysql</a>&nbsp;&nbsp;<a href=".././tag/replication.html">replication</a>&nbsp;&nbsp;<a href=".././tag/scalability.html">scalability</a>&nbsp;&nbsp;<a href=".././tag/tutorial.html">tutorial</a>&nbsp;&nbsp;</p>

</div><!-- /.post-info -->
          
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="khuevu">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

          <p>There are <a href=".././2012/10/06/mysql-replication.html#disqus_thread">comments</a>.</p>
        </footer>
      </article>
    </li>
    
  
  </ol>
  
<p class="paginator">
  
  
</p>



</section>

    <footer id="footer" class="body">
      <address id="about">
      </address>
    </footer>
    
<script type="text/javascript">
    var disqus_shortname = 'waterspinach';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

  </body>
</html>