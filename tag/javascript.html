<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Water Spinach - javascript</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href=".././theme/css/main.css" type="text/css"/>
    <link href="/" type="application/atom+xml" rel="alternate" title="Water Spinach Atom Feed" />
    
    
    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <!--[if lte IE 7]>
        <link rel="stylesheet" type="text/css" media="all" href=".././css/ie.css"/>
        <script src=".././js/IE8.js" type="text/javascript"></script><![endif]-->

    <!--[if lt IE 7]>
         <link rel="stylesheet" type="text/css" media="all" href=".././css/ie6.css"/><![endif]-->

        
<script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34233563-1']);
    _gaq.push(['_trackPageview']);
    _gaq.push(['_gat._anonymizeIp']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>

        
  </head> 
  <body id="index" class="home">
    
<a href="https://github.com/khuevu">

<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />

</a>

    <!--Logo, site metadata and navigation menu-->
    <header id="side" class="body">
    <aside id="logo"><div><img src=".././theme/images/logo.jpg" width="210" height="140"/></div>
    <hgroup>
    <h1 id="title"><a href="../.">Water Spinach </a></h1>
    <h2>Enough to fill the stomach</h2>
    </hgroup>
    </aside>  
    <nav>
        <ul class="menu">
            
            <li ><a href=".././category/Blog.html">Blog</a></li>
            
            <li><a href=".././tags.html">Tags</a></li>
            <li><a href=".././archive.html">Archive</a></li>
            <li><a href=".././about.html">About</a></li>
        </ul>
    </nav>
    <div id="credit">
    Powered by <a href="http://pelican.notmyidea.org/">Pelican</a>
    </div>
    </header>
    <!-- Content Block -->
    
<section id="content" class="body">

<ol id="posts" class="hfeed" start="9">
  
    <li>
      <article class="entry">
        <header>
        <h1 class="entry-title"><a href=".././2013/01/22/fileupload-javascript.html">Uploading file using Javascript</a></h1>
        <abbr class="published" title="2013-01-22T00:00:00">
                Tue 22 January 2013
        </abbr>
        <p>In <a href=".././category/Blog.html"><b>Blog</b></a></p>
        </header>
        <div class="entry-content">
          <p>A few months ago, I have written a <a href="https://chrome.google.com/webstore/detail/social-snap/bnhlaifngpmodnnkpebagndhomlcnaed">chrome extension</a> for instant sharing of captured content of a webpage to Facebook. So one of the requirement is that the captured image data is uploaded to Facebook. The familiar web flow of uploading a file to serverwould be presenting user with upload file form (html form with enctype="multipart/form-data") and let them select the file: </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;https://graph.facebook.com/me/photos?access_token=...&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
<span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;file&quot;</span><span class="nt">&gt;</span>Filename:<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;file&quot;</span> <span class="na">name=</span><span class="s">&quot;file&quot;</span> <span class="na">id=</span><span class="s">&quot;file&quot;</span><span class="nt">&gt;&lt;br&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Submit&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</td></tr></table>

<p>So how do we accomplish it in Javascript? First, we need to know what is actually sent in the body of the HTTP request when a file is uploaded using the above method. Well, the body of request originated from a "multiplart/form-data" form is indeed a multipart message. The message follows the <a href="http://en.wikipedia.org/wiki/MIME">MIME internet standard</a>.<br />
</p>
<h2>MIME standard</h2>
<p>MIME was intended to be the standard for describing content of an email. An email messages often consists of multiple part, for example, text, non-ASCII language content, attachement, binary content (images, movies). Its usage, however, have extended far beyond the field of email. </p>
<p>HTTP uses MIME standard when it needs to transfer data which is binary or and may mix with other data format. One essential thing to know about MIME is that its initial design requirements include requiring no changes to existing email servers, which only support plain text email. Thus you will be right if you expect the MIME message to be sent as plain text message (ASCII characters). The HTTP file upload request we will examine is also in the plain text format like usual HTTP POST requests. </p>
<h2>HTTP multipart request:</h2>
<p>When uploading a photo to facebook, open firebug and observe the request:</p>
<div class="codehilite"><pre><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">multipart</span><span class="o">/</span><span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="p">;</span> <span class="n">boundary</span><span class="p">=</span><span class="n">boundary</span>

<span class="o">--</span><span class="n">boundary</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Disposition</span><span class="p">:</span> <span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="p">;</span> <span class="n">name</span><span class="p">=</span>&quot;<span class="n">source</span>&quot;<span class="p">;</span> <span class="n">filename</span><span class="p">=</span>&quot;<span class="n">capture</span><span class="p">.</span><span class="n">png</span>&quot;
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">image</span><span class="o">/</span><span class="n">png</span>

<span class="n">PGh0bWw</span><span class="o">+</span><span class="n">CiAgPGhlYWQ</span><span class="o">+</span><span class="n">CiAgPC9oZWFkPgogIDxib2R5PgogICAgPHA</span><span class="o">+</span><span class="n">VGhpcyBpcyB0aGUg</span>
 <span class="n">Ym9keSBvZiB0aGUgbWVzc2FnZS48L3A</span><span class="o">+</span><span class="n">CiAgPC9ib2R5Pgo8</span>
<span class="p">...</span> 
 <span class="n">L2h0bWw</span><span class="o">+</span><span class="n">Cg</span><span class="o">==</span>
<span class="o">--</span><span class="n">boundary</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Disposition</span><span class="p">:</span> <span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="p">;</span> <span class="n">name</span><span class="p">=</span>&quot;<span class="n">message</span>&quot;

<span class="n">My</span> <span class="n">comment</span> <span class="k">for</span> <span class="n">the</span> <span class="n">uploaded</span> <span class="n">image</span>
<span class="o">--</span><span class="n">boundary</span><span class="o">--</span>
</pre></div>


<p>We can observe from the message.</p>
<ul>
<li>First the HTTP Request header. <code>Content-Type</code> attribute tell you that the message is a multipart message. Notice the <code>boundary</code> name value pair. It specifies the string that will be used as the message's parts separator. The boundary value can be any string which must not be contain in any other part of the message. It, appended with a <code>--</code> prefix, is used as boundary between parts. And it is appended <code>--</code> at both end to mark the end of the message.<br />
</li>
<li>Each message part has its own headers. <code>Content-Type</code> is <code>image/png</code> for the image data. For the comment data, you can leave this header out as it is default to text. <code>Content-Disposition</code> in MIME standard supposes to tell the receiver how the content should be presented. In HTTP, it is used as request parameter's name. </li>
<li>The request header and request body, as well as part header and body is separated by a blank line (<code>\r\n</code>) </li>
<li>The image data is base64 encoded.</li>
</ul>
<p>From this obseravation, we can easily construct the upload file request.<br />
</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span class="kd">function</span> <span class="nx">uploadFacebookPhoto</span><span class="p">(</span><span class="nx">imageData</span><span class="p">,</span> <span class="nx">caption</span><span class="p">,</span> <span class="nx">accessToken</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">photoUrl</span> <span class="o">=</span> <span class="s1">&#39;https://graph.facebook.com/me/photos?access_token=&#39;</span> <span class="o">+</span> <span class="nx">accessToken</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="nx">photoUrl</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;multipart/form-data; boundary=-----&quot;</span><span class="p">)</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;successfully post the message&#39;</span><span class="p">);</span>
            <span class="nx">controller</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">prepareMIMEMessage</span><span class="p">(</span><span class="nx">imageData</span><span class="p">,</span> <span class="nx">caption</span><span class="p">,</span> <span class="nx">accessToken</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">sendAsBinary</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>In the above code, the function <code>prepareMIMEMessage</code> does the construction of the message body. </p>
        </div>
        <footer>
          <div class="post-info">
<p>Tags: &nbsp;<a href=".././tag/javascript.html">javascript</a>&nbsp;&nbsp;<a href=".././tag/facebook graph.html">facebook graph</a>&nbsp;&nbsp;</p>

</div><!-- /.post-info -->
          
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="khuevu">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

          <p>There are <a href=".././2013/01/22/fileupload-javascript.html#disqus_thread">comments</a>.</p>
        </footer>
      </article>
    </li>
    
  
  </ol>
  
<p class="paginator">
  
  
</p>



</section>

    <footer id="footer" class="body">
      <address id="about">
      </address>
    </footer>
    
<script type="text/javascript">
    var disqus_shortname = 'waterspinach';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

  </body>
</html>