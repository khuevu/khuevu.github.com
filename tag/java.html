<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Water Spinach - java</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href=".././theme/css/main.css" type="text/css"/>
    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Water Spinach Atom Feed" />
    
    
    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <!--[if lte IE 7]>
        <link rel="stylesheet" type="text/css" media="all" href=".././css/ie.css"/>
        <script src=".././js/IE8.js" type="text/javascript"></script><![endif]-->

    <!--[if lt IE 7]>
         <link rel="stylesheet" type="text/css" media="all" href=".././css/ie6.css"/><![endif]-->

        
<script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34233563-1']);
    _gaq.push(['_trackPageview']);
    _gaq.push(['_gat._anonymizeIp']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>

        
  </head> 
  <body id="index" class="home">
    
<a href="https://github.com/khuevu">

<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />

</a>

    <!--Logo, site metadata and navigation menu-->
    <header id="side" class="body">
    <aside id="logo"><div><img src=".././theme/images/logo.jpg" width="210" height="140"/></div>
    <hgroup>
    <h1 id="title"><a href="../.">Water Spinach </a></h1>
    <h2>Enough to fill the stomach</h2>
    </hgroup>
    </aside>  
    <nav>
        <ul class="menu">
            
            <li ><a href=".././category/Blog.html">Blog</a></li>
            
            <li><a href=".././tags.html">Tags</a></li>
            <li><a href=".././archive.html">Archive</a></li>
            <li><a href=".././about.html">About</a></li>
        </ul>
    </nav>
    <div id="credit">
    Powered by <a href="http://pelican.notmyidea.org/">Pelican</a>
    </div>
    </header>
    <!-- Content Block -->
    
<section id="content" class="body">

<ol id="posts" class="hfeed" start="9">
  
    <li>
      <article class="entry">
        <header>
        <h1 class="entry-title"><a href=".././2013/01/27/understand-hibernate.html">Application Design with Hibernate</a></h1>
        <abbr class="published" title="2013-01-27T00:00:00">
                Sun 27 January 2013
        </abbr>
        <p>In <a href=".././category/Blog.html"><b>Blog</b></a></p>
        </header>
        <div class="entry-content">
          <p>This article aims to discuss the basic design pattern of a web application using Hibernate; the basic concepts that you need to know well before actually implementing a Hibernate-based application. Hibernate Documentation can be a little bit confusing sometimes. This article tries to distill the important points to help you have a better understanding of Hibernate. And if you are already using Hibernate, hope it is still useful for you. Fundamentals always serves as building blocks for advanced techniques, an idea well illustrated in old time Chinese martial art movies. </p>
<h2>Hibernate's business case:</h2>
<p>Hibernate has <code>Session</code> object as its persistence interface. All of the database operations can be invoked through the <code>Session</code> object. This <code>Session</code> object should be accessed from a single thread. How long a <code>Session</code> object lives will be determined by your application design and its business use case. </p>
<p>Why? when designing a business application, operations are grouped into business transaction, in which, all operations are considered successfully executed only if none of them fail to execute. For example, in a online shopping application, operation to deduct the sold quality from available stock and operation of getting payment from customers are grouped into one transaction. Only when payment is made successfully, the former one is persisted. In other words, a business transaction coordinates the writing out of changes to affected data. Some data can only be meaningfully changed if other is changed too. And in Hibernate, a <code>Session</code> represents exactly that, a business transaction or a <code>unit of work</code>, a term used by <a href="http://docs.jboss.org/hibernate/core/3.3/reference/en/html/transactions.html#transactions-locking">Hibernate documentation</a>. In this article, we use the terms business transaction, unit of work, conversation interchangably. </p>
<p>Hibernate is mainly designed for web application. In which, A <code>Session</code>, therefore, can span a request (session-per-request) or a conversation - multiple requests, response cycles (however, you should not keep the Session for a long conversion. We will discuss this later).<br />
</p>
<p>So how exactly a <code>Session</code> is related to a business transaction, and why we need to decide how we keep the <code>Session</code>? </p>
<p>A <code>Session</code> is not only an abstract layer for your database operations, but also an objects cache. When an object is loaded from a <code>Session</code>, Hibernate caches it in memory. This object is often called <code>managed object</code>. A particular <code>Session</code> always knows which objects it has loaded. When flush is called on this <code>Session</code>, Hibernate check for modification on the object (dirty check) and the change made to the object, if any, is automatically flushed to database. </p>
<p>This mechanism is perfectly suitable for a match between a <code>Session</code> and a business transaction. Change during a transaction is staged in memory - <code>Session</code>'s cache. Change is persisted by flushing the change to database. If there is error, i.e, Hibernate throws exceptions, <code>Session</code> object needs to be discarded, database changes need to be rolled back if necessary. A <code>Session</code> also does version checking of managed object when updating to database to detect changes made to this data entity between the time it is loaded to memory and the time it is persisted back to database, which ensures the data integrity during a transaction. </p>
<h2>Hibernate's Design Pattern:</h2>
<p>From Hibernate <a href="http://docs.jboss.org/hibernate/core/3.3/reference/en/html/transactions.html#transactions-basics">documentation</a>:</p>
<blockquote>
<p>A Session is an inexpensive, non-threadsafe object that should be used once and then discarded for. A Session will not obtain a JDBC Connection, or a Datasource, unless it is needed. It will not consume any resources until used. </p>
</blockquote>
<p>A Hibernate Session can span multiple physical database transactions. Hibernate <code>Session</code> will acquire a JDBC connection when transaction start. That means all communication with database must occur inside a transaction. When transaction is committed, Hibernate will release the collection. Typically, your data access code will be: </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span class="n">Session</span> <span class="n">sess</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
<span class="n">Transaction</span> <span class="n">tx</span><span class="o">;</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
    <span class="c1">//do some work</span>
    <span class="o">...</span>
    <span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">tx</span><span class="o">!=</span><span class="kc">null</span><span class="o">)</span> <span class="n">tx</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">finally</span> <span class="o">{</span>
    <span class="n">sess</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>The code above is simplest form to give you an idea of different steps handling a <code>Session</code>. Usually, you should access the <code>Session</code> object through <code>SessionFactory.getCurrentSession</code>, or putting the transaction boiler plate code in a filter or AOP interceptor instead. </p>
<p>If, outside a transaction, you try to access a data object or its laizly initialized property (we will talk about it later) exception will be thrown by Hibernate. You will need to start DB transactions to write to DB or transactions to read only. That's why you might have several physical transactions over a Session - a business transaction. We will discuss these scenarios nextby considering some of the design pattern for Hibernate web application: </p>
<h3>Session per Request:</h3>
<p>Your business transaction spans only one request. For each thread that handles incoming request, a new <code>Session</code> is opened and closed after processing is finished. </p>
<p>You might encountered a problem with this design. Your <code>Session</code> object is normally closed when the main processing logic is completed but before your application renders view to return to client. When rendering view, some uninitialized data might need to retrieved for displayed; but the <code>Session</code> is already closed. A typical scenario is displaying collection which is marked as <code>LazyInitialization</code>. One feature of Hibernate is Lazy Loading. In ORM, relations between tables are represented as properties of collections in a object model. When retriveing the object from database, if the object's collection is lazy loaded, Hibernate defers the retrieval of the collection until being queried. It helps avoid overflow of available memory due to large collections. </p>
<p>The solution to this problem is keep the session open until the view rendered completely but just before the response is returned to client (<code>Open Session In View</code>). Alternatively, you can have two DB transactions for one <code>Session</code>. The first transaction is opened for main logic processing. Don't discard the <code>Session</code> after that. The second transaction is a read only transaction started during rendering phase. You can find a very good article about these solutions <a href="https://community.jboss.org/wiki/OpenSessionInView">here</a>. </p>
<h3>Extended Session - Session per conversation</h3>
<p>Your business transaction spans multiple request-reply cycles. In this Extended Session pattern, you reused the <code>Session</code> object between requests and only discard it when the unit of work complete. The <code>Session</code> object is bind to the conversation by storing in the <code>HttpSession</code>. The <code>Session</code> should keep the transaction boundary within a request processing time:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span class="c1">// Obtain new Session at the begining of unit of work.</span>
<span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>  
<span class="n">session</span><span class="o">.</span><span class="na">setFlushMode</span><span class="o">(</span><span class="n">FlushMode</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span> <span class="c1">// IMPORTANT</span>

<span class="c1">//Obtain new JDBC Connection, start DB Transaction</span>
<span class="n">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span> 
<span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
<span class="o">...</span>
<span class="c1">// release JDBC Connection during the unit of work. Waiting for user next request.</span>
<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</pre></div>
</td></tr></table>

<p>The <code>Session</code> should be disconnectied from JDBC connection during user think time by calling <code>tx.commit()</code>. Note that you need to set the <code>FlushMode</code> to <code>NEVER</code>. The <code>tx.commit()</code> will auto flush the session otherwise. We are still in a unit of work (business transaction), thus we don't want to flush the cahnge to database yet. (I believe there is a bug in Hibernate documentation, in which it states that the <code>FlushMode.MANUAL</code> will prevent the flushing when a transaction is committed. But the <a href="http://docs.jboss.org/hibernate/orm/3.2/api/org/hibernate/Transaction.html">java doc</a> says the former')</p>
<p>The next request within the same unit of work, the <code>Session</code> object will open another database transaction: </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span class="n">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span> <span class="c1">// same Session, obtain new JDBC Connection</span>

<span class="c1">//previously loaded foo object. </span>
<span class="n">foo</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;bar&quot;</span><span class="o">);</span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</pre></div>
</td></tr></table>

<p>The <code>Session</code> knows the foo object is the one it loaded previously. At the last transaction in the conversation, we flush the change to database and discard the <code>Session</code>: </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span class="n">session</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</pre></div>
</td></tr></table>

<p>Change made to the foo object will be flushed to database. This approach is efficient in database access. No resource is used until needed. Refer to this <a href="https://community.jboss.org/wiki/OpenSessionInView#What_about_the_extended_Session_pattern_for_long_Conversations">article</a> for more details. </p>
<p>And you should never have a long transaction spanning the whole conversation. Having a long database transaction not only hogs resource but also leads to stale data due to concurrent access. StaleObjectStateException will be thrown. It prevents your application to scale concurrently. (Do note that within a thread, a single database transaction is going to perform better than many small transactions, <a href="http://docs.jboss.org/hibernate/core/3.3/reference/en/html/transactions.html#transactions-demarcation">even for reading data</a>)</p>
<p>This pattern, however, is not suitable for a long conversation. With loaded objects kept in memory, you will soon run hit OutOfMemory error if you keep the <code>Session</code> for too long. So for a long conversation, we use an alternative approach. </p>
<h3>Detached Session - For long conversation</h3>
<p>To keep memory from overflowing during a long conversation, we use a new session for each user interaction. In this pattern, the staging change will be kept by mean of persistent objects. The managed objects that change is made directly to. You keep these objects between interactions, detach them from old <code>Session</code> when it is closed and re-attach them to the new <code>Session</code>. So the persistent objects are ones that are kept within <code>HttpSession</code> 's context within a unit of work. You can re-attach an object by calling <code>Session</code>'s <code>merge</code> or <code>saveOrUpdate</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span class="c1">// foo is an instance loaded by a previous Session</span>
<span class="n">foo</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;bar&quot;</span><span class="o">);</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span> <span class="c1">// open new session</span>
<span class="n">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>

<span class="n">session</span><span class="o">.</span><span class="na">saveOrUpdate</span><span class="o">(</span><span class="n">foo</span><span class="o">);</span> <span class="c1">// Use merge() if &quot;foo&quot; might have been loaded already</span>

<span class="n">t</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</pre></div>
</td></tr></table>

<h2>Hibernate Integration</h2>
<p>In practice, we don't often need to write our own transaction code. We use Hibernate or Spring's HibernateTransactionManager instead. These transaction managers wrap a transaction around method invokation, which requires database accesses. But in essense, they are all doing the same thing as described above: obtain a session, start the transaction, flush the session if needed, commit the transaction, discard the session if needed; roll back transaction and discard session if exception is thrown. </p>
<p>Transaction's boundary can be defined using annotation or clear <a href="https://community.jboss.org/wiki/SessionHandlingWithAOP">point cut (AOP)</a>; transactions can be nested; A business transaction might not involve only Hibernate's transaction but other resources' transactions as well; nested transactions. We will discuss these matters in next article on hibernate. </p>
        </div>
        <footer>
          <div class="post-info">
<p>Tags: &nbsp;<a href=".././tag/hibernate.html">hibernate</a>&nbsp;&nbsp;<a href=".././tag/java.html">java</a>&nbsp;&nbsp;</p>

</div><!-- /.post-info -->
          
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="khuevu">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

          <p>There are <a href=".././2013/01/27/understand-hibernate.html#disqus_thread">comments</a>.</p>
        </footer>
      </article>
    </li>
    
  
    <li>
      <article class="entry">
        <header>
        <h1 class="entry-title"><a href=".././2012/10/07/spring-hibernate-mysqlreplication.html">Integrate Spring and Hibernate with MySQL master/slave database</a></h1>
        <abbr class="published" title="2012-10-07T00:00:00">
                Sun 07 October 2012
        </abbr>
        <p>In <a href=".././category/Blog.html"><b>Blog</b></a></p>
        </header>
        <div class="entry-content">
          <p>In my previous <a href="../2012/10/06/mysql-replication.html">post</a>, we have setup one master and one slave MySQL database. If you write your application to interact with database using jdbc connector, it already has the <a href="http://dev.mysql.com/doc/refman/5.1/en/connector-j-reference-replication-connection.html">support for database replication</a>. Basically, you need to use <code>com.mysql.jdbc.ReplicationDriver</code> and change connection to <code>readOnly</code> when you want it to direct traffics to slave instances. What if your application interfaces with database through Hibernate API? Hibernate doesn't explicitly support the replication. Setting Hibernate or Spring's transactions to <code>readOnly</code> doesn't change the underlying jdbc connection to <code>readOnly</code>. </p>
<p>The first thing come to mind is to have two separate instances of <code>Datasource</code>, one which connection set to <code>readOnly</code> and one not; and have two Hibernate's <code>SessionFactory</code> contain each. However, this method changes your existing programming model. The second choice is to access the underlying jdbc connection of Hibernate's SessionFactory and switch it to <code>readOnly</code> when it is read operation. </p>
<p>Here we are going to use Spring's AspectJ API to implement this. With Spring AspectJ annotation, we can introduce the switching of connection <code>readOnly</code> with least amount of change on code.<br />
</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="codehilite"><pre><span class="o">...</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionInterceptor</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">SessionFactory</span> <span class="n">sessionFactory</span><span class="o">;</span>

    <span class="nd">@Around</span><span class="o">(</span><span class="s">&quot;@annotation=ReadOnlyConnection&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">proceed</span><span class="o">(</span><span class="n">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">();</span>
        <span class="n">ConnectionReadOnly</span> <span class="n">readOnlyWork</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConnectionReadOnly</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">session</span><span class="o">.</span><span class="na">doWork</span><span class="o">(</span><span class="n">readOnlyWork</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">readOnlyWork</span><span class="o">.</span><span class="na">switchBack</span><span class="o">();</span>
            <span class="n">session</span><span class="o">.</span><span class="na">doWork</span><span class="o">(</span><span class="n">readOnlyWork</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Next, define the <code>@ReadOnlyConnection</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">ReadOnlyConnection</span> <span class="o">{</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>The <code>ConnectionReadOnly</code> class implements <code>org.hibernate.jdbc.Work</code> interface.<br />
</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionReadOnly</span> <span class="kd">implements</span> <span class="n">Work</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Connection</span> <span class="n">connection</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setReadOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">...</span>

    <span class="o">}</span>

    <span class="c1">//method to restore the connection state before intercepted</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">switchBack</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span> 
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>To enable AspectJ annotation in Spring, you need to add to spring context config file: </p>
<div class="codehilite"><pre><span class="nt">&lt;aop:aspectj-autoproxy/&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;connectionInterceptor&quot;</span> <span class="na">class=</span><span class="s">&quot;com.x.y.z.ConnectionInterceptor&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>


<p>So for any <code>ReadOnly</code> method at your DAO layer, you just need to add the <code>@ReadOnlyConnection</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span class="o">...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomeDaoImpl</span> <span class="kd">implements</span> <span class="n">SomeDao</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">SessionFactory</span> <span class="n">sessionFactory</span><span class="o">;</span>
    <span class="o">...</span>

    <span class="nd">@ReadOnlyConnection</span>
    <span class="kd">public</span> <span class="n">Some</span> <span class="nf">get</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sessionFactory</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">();</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>In case you don't want to use annotation, you can use Spring's xml configuration. For the above example, we will have: </p>
<div class="codehilite"><pre><span class="nt">&lt;aop:config&gt;</span>
    <span class="nt">&lt;aop:aspect</span> <span class="na">id=</span><span class="s">&quot;connectionAspect&quot;</span> <span class="na">ref=</span><span class="s">&quot;connectionInterceptor&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">&quot;connPointCut&quot;</span> <span class="na">expression=</span><span class="s">&quot;execution(* com.x.y.SomeDaoImpl.get(..))&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:around</span> <span class="na">method=</span><span class="s">&quot;proceed&quot;</span> <span class="na">pointcut-ref=</span><span class="s">&quot;connPointCut&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/aop:aspect&gt;</span>
<span class="nt">&lt;/aop:config&gt;</span>
</pre></div>
        </div>
        <footer>
          <div class="post-info">
<p>Tags: &nbsp;<a href=".././tag/java.html">java</a>&nbsp;&nbsp;<a href=".././tag/spring.html">spring</a>&nbsp;&nbsp;<a href=".././tag/hibernate.html">hibernate</a>&nbsp;&nbsp;<a href=".././tag/mysql.html">mysql</a>&nbsp;&nbsp;<a href=".././tag/scalability.html">scalability</a>&nbsp;&nbsp;</p>

</div><!-- /.post-info -->
          
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="khuevu">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

          <p>There are <a href=".././2012/10/07/spring-hibernate-mysqlreplication.html#disqus_thread">comments</a>.</p>
        </footer>
      </article>
    </li>
    
  
  </ol>
  
<p class="paginator">
  
  
</p>



</section>

    <footer id="footer" class="body">
      <address id="about">
      </address>
    </footer>
    
<script type="text/javascript">
    var disqus_shortname = 'waterspinach';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

  </body>
</html>