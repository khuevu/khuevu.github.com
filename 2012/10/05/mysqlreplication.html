<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />    
    <meta name="author" content="Vu Minh Khue"/>
    
    <title>Water Spinach</title>

    <link rel="stylesheet" href="/theme/css/foundation.min.css" />
    <link rel="stylesheet" href="/theme/css/main.css" type="text/css"/>
    <link rel="stylesheet" href="/theme/css/foundation-icons.css"/>
    
    <!-- Feeds -->

    <script src="/theme/js/vendor/modernizr.js"></script>

    <!-- Font Google Droid -->
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700|Droid+Sans+Mono|Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

    <!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34233563-1']);
  _gaq.push(['_trackPageview']);
  _gaq.push(['_gat._anonymizeIp']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  <body>
    
     
  <div class="off-canvas-wrap">
    <div class="inner-wrap">
      <!-- Mobile Navigation -->
      <nav class="tab-bar show-for-small-only">
        <section class="left-small show-for-small-only">
          <a class="left-off-canvas-toggle menu-icon"><span></span></a>
        </section>

        <section class="middle tab-bar-section">
          <h1 class="title">Water Spinach</h1>
        </section>

        <section class="right-small">
          <a class="right-off-canvas-toggle menu-icon"><span></span></a>
        </section>
      </nav>

      <aside class="left-off-canvas-menu">
        <ul class="off-canvas-list">
          <li  class="active" ><a href="../../../category/Programming.html">Programming</a></li>
          <li ><a href="../../../category/Random.html">Random</a></li>
          <li><a href="../../../archive.html">Archive</a>  </li>
          <li><a href="#">About Me</a></li>
        </ul>

      </aside>

      <aside class="right-off-canvas-menu">
        <ul class="off-canvas-list">
          <li><label>Tags</label></li>
          <li><a href="../../../tag/tunnel.html">tunnel</a></li>
          <li><a href="../../../tag/spring.html">spring</a></li>
          <li><a href="../../../tag/tutorial.html">tutorial</a></li>
          <li><a href="../../../tag/firewall.html">firewall</a></li>
          <li><a href="../../../tag/mysql.html">mysql</a></li>
          <li><a href="../../../tag/hibernate.html">hibernate</a></li>
          <li><a href="../../../tag/tcp.html">tcp</a></li>
          <li><a href="../../../tag/http.html">http</a></li>
          <li><a href="../../../tag/tunneling.html">tunneling</a></li>
          <li><a href="../../../tag/javascript.html">javascript</a></li>
          <li><a href="../../../tag/firefox.html">firefox</a></li>
          <li><a href="../../../tag/python.html">python</a></li>
          <li><a href="../../../tag/scalability.html">scalability</a></li>
          <li><a href="../../../tag/encoding.html">encoding</a></li>
          <li><a href="../../../tag/pygame.html">pygame</a></li>
          <li><a href="../../../tag/java.html">java</a></li>
          <li><a href="../../../tag/replication.html">replication</a></li>
          <li><a href="../../../tag/optimization.html">optimization</a></li>
          <li><a href="../../../tag/nexus.html">nexus</a></li>
          <li><a href="../../../tag/facebook graph.html">facebook graph</a></li>
          <li><a href="../../../tag/android.html">android</a></li>
        </ul>
      </aside>

      <!-- Medium or Wide Screen Navigation -->
      <nav class="top-bar hide-for-small-only" data-topbar>
        <ul class="title-area">
          <li class="name">
            <h1><a href="../../..">Water Spinach</a></h1>
          </li>
        </ul>

        <section class="top-bar-section">
          <ul class="left">
            <li  class="active" ><a href="../../../category/Programming.html">Programming</a></li>
            <li ><a href="../../../category/Random.html">Random</a></li>
            <li><a href="../../../archive.html">Archive</a>  </li>
            <li><a href="#">About Me</a></li>
          </ul>
        </section>
      </nav>

      <section class="main-section">
        <div class="row">
          <!-- Main Content -->
          <div class="small-12 medium-9 columns" role="content">
<article>
  <h2>A Tutorial to set up MySQL replication (master/slave) for high&nbsp;scalability</h2>
  <p>In this tutorial, we will set up two instances of MySQL on your localhost, one master and one slave and enable data replication between the master and the&nbsp;slave.</p>
<p>There are several options when you want to scale horizontally with a MySQL database including database sharding, using MySQL Cluster with <span class="caps">NDB</span> storage or a master/slave setup. You can refer to this <a href="http://www.oshyn.com/_blog/General/post/A_Summary_of_Scaling_Options_for_MySQL/">link</a> for a more detailed summary. Master/slave will be suitable for your application if it performs a lot of read operations rather than write. So distributing the read operations accross multiple instance will help reduce the load on one master instance and enables scaling&nbsp;out. </p>
<h3>Configuration</h3>
<p>If you haven&#8217;t had MySQL, download it from <a href="http://www.mysql.com/downloads/mysql/">here</a>, untar it and extract to a folder of your choice. Add the <code>bin</code> folder to your <code>PATH</code> if you don&#8217;t want to specify the full path when invoking the&nbsp;process.  </p>
<p>Create the folder for config files and data of master and slave&nbsp;instances:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>mkdir -vp ~/replication/<span class="o">{</span>master,slave<span class="o">}</span>/<span class="o">{</span>conf,data,log<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Run <code>mysql_install_db</code> script to populate the require <code>mysql</code> schema for each&nbsp;instance: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre>scripts/mysql_install_db --no-defaults --datadir<span class="o">=</span>~/replication/master/data
scripts/mysql_install_db --no-defaults --datadir<span class="o">=</span>~/replication/slave/data
</pre></div>
</td></tr></table>

<p>Configure master instance: In <code>~/replication/master/conf/</code>, create <code>my.cnf</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># master my.cnf</span>

<span class="o">[</span>client<span class="o">]</span> 
<span class="nv">port</span>    <span class="o">=</span>   3306
<span class="nv">socket</span>  <span class="o">=</span>   ~/replication/master/mysqld.sock

<span class="o">[</span>mysqld<span class="o">]</span>
<span class="nv">socket</span>  <span class="o">=</span>   ~/replication/master/mysqld.sock
<span class="nv">port</span>    <span class="o">=</span>   3306
<span class="nv">datadir</span> <span class="o">=</span>   ~/replication/master/data
<span class="c">#basedir: location of your MySQL installation</span>
<span class="nv">basedir</span> <span class="o">=</span>   ... 
...
</pre></div>
</td></tr></table>

<p>Next, start the master instance using the&nbsp;command: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>mysqld --defaults-file<span class="o">=</span>~/replication/master/conf/my.cnf
</pre></div>
</td></tr></table>

<p>Create <code>replicatedb</code>, after log in using mysql&nbsp;client: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>mysql&gt; CREATE SCHEMA <span class="sb">`</span>replicatedb<span class="sb">`</span>;
</pre></div>
</td></tr></table>

<p>Populate some table and data for your schema. Next we need to tell the server to use binary log to log change made to this schema. Add the following lines to the <code>my.cnf</code> file, under server&nbsp;section: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre>log-bin <span class="o">=</span>   ~/replication/master/log/mysql-bin.log
binlog-do-db    <span class="o">=</span>   replicatedb
server-id   <span class="o">=</span>   1
</pre></div>
</td></tr></table>

<p>Note that the server-id must be unique between master and slaves. If you want replication for multiple schema, use multiple <code>binlog-do-db</code> option. Restart the&nbsp;server.</p>
<h3>Create user for&nbsp;replication:</h3>
<p>Next create the user which has the <code>REPLICATION SLAVE</code> permission, which slave instances will use to access master data. In mysql client&nbsp;command: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="n">USER</span> <span class="s1">&#39;slave&#39;</span><span class="o">@</span><span class="s1">&#39;127.0.0.1&#39;</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="ss">`slave`</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">GRANT</span> <span class="n">REPLICATION</span> <span class="n">SLAVE</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">&#39;slave&#39;</span><span class="o">@</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<h3>Obtain replication&nbsp;point</h3>
<p>Still in the mysql client&nbsp;console: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="kp">TABLES</span> <span class="k">WITH</span> <span class="k">READ</span> <span class="k">LOCK</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">MASTER</span> <span class="n">STATUS</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<p>Output: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">+------------------+----------+------------------+------------------+</span>
<span class="o">|</span> <span class="n">File</span>             <span class="o">|</span> <span class="n">Position</span> <span class="o">|</span> <span class="n">Binlog_Do_DB</span>     <span class="o">|</span> <span class="n">Binlog_Ignore_DB</span> <span class="o">|</span>
<span class="o">+------------------+----------+------------------+------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="p">.</span><span class="mi">000016</span> <span class="o">|</span>      <span class="mi">106</span> <span class="o">|</span> <span class="n">replicatedb</span>      <span class="o">|</span>                  <span class="o">|</span>
<span class="o">+------------------+----------+------------------+------------------+</span>
</pre></div>
</td></tr></table>

<p>The above commands will lock the master database, preventing any writes to it, and output the current coordinate of binary log. Then we will dump a database snapshot of the master and restore it to the slave instance. If we don&#8217;t look the database, and new change made to it, there will be inconsistence between the master&#8217;s data and the snapshot, which leads to a corrupted databases on the&nbsp;slave. </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>mysql -u root -p replicatedb &gt; replicatedb.sql
</pre></div>
</td></tr></table>

<h3>Setup slave&nbsp;instance</h3>
<p>To setup the slave, instance, create a similar configure file as master instance and change the port number to 3307. Enable <code>binlog</code> for slave instance if you want it later to serve as the master to other slave instances (which help reduces the sync requests to a single master). And add the following&nbsp;lines:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">[</span>mysqld<span class="o">]</span>
...
server-id   <span class="o">=</span>   2
replicate-do-db <span class="o">=</span>   replicatedb
</pre></div>
</td></tr></table>

<p>Start slave&nbsp;instance: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>mysqld --defaults-file<span class="o">=</span>~/replication/slave/conf/my.cnf
</pre></div>
</td></tr></table>

<p>Restore the dumped&nbsp;file: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>mysql -u root -p -h <span class="s2">&quot;127.0.0.1&quot;</span> -P 3307 replicatedb &lt; replicatedb.sql
</pre></div>
</td></tr></table>

<p>After you has restore the dumped data to slave instance, unlock the table in master&nbsp;instance:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">UNLOCK</span> <span class="kp">TABLES</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<p>Then we need to tell the slave instance the username and password it is going to use for replication, the coordinate of the bin log file. Login to slave instance using mysql client, type in the following&nbsp;commands:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">STOP</span> <span class="n">SLAVE</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CHANGE</span> <span class="n">MASTER</span> <span class="k">TO</span>
        <span class="n">MASTER_HOST</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
        <span class="n">MASTER_USER</span><span class="o">=</span><span class="s1">&#39;slave&#39;</span><span class="p">,</span>
        <span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="s1">&#39;slave&#39;</span><span class="p">,</span>
        <span class="n">MASTER_PORT</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span>
        <span class="n">MASTER_LOG_FILE</span><span class="o">=</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="p">.</span><span class="mi">000016</span><span class="p">,</span>
        <span class="n">MASTER_LOG_POS</span><span class="o">=</span><span class="mi">106</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">START</span> <span class="n">SLAVE</span><span class="p">;</span>
</pre></div>
</td></tr></table>
  <hr/>
  <h6>Written by <a href="../../../author/vu-minh-khue.html">Vu Minh Khue</a> in <a href="../../../category/Programming.html">Programming</a> on Fri 05 October 2012. Tags: <a href="../../../tag/mysql.html">mysql</a>, <a href="../../../tag/replication.html">replication</a>, <a href="../../../tag/scalability.html">scalability</a>, <a href="../../../tag/tutorial.html">tutorial</a>, </h6>
</article>

<hr/>
<div class="row">
  <div class="small-12 columns">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'waterspinach';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>
          </div>

          <!-- Side Panels for Medium or Wide Screen -->
          <aside class="hide-for-small-only medium-3 columns">
            <div class="panel">
            <div>
              <!-- Pelican's tag cloud -->
              <label>Tags</label>
              <ul class="tagcloud">
                <li class="tag-4"><a href="../../../tag/tunnel.html">tunnel</a></li>
                <li class="tag-4"><a href="../../../tag/spring.html">spring</a></li>
                <li class="tag-4"><a href="../../../tag/tutorial.html">tutorial</a></li>
                <li class="tag-4"><a href="../../../tag/firewall.html">firewall</a></li>
                <li class="tag-1"><a href="../../../tag/mysql.html">mysql</a></li>
                <li class="tag-2"><a href="../../../tag/hibernate.html">hibernate</a></li>
                <li class="tag-4"><a href="../../../tag/tcp.html">tcp</a></li>
                <li class="tag-4"><a href="../../../tag/http.html">http</a></li>
                <li class="tag-4"><a href="../../../tag/tunneling.html">tunneling</a></li>
                <li class="tag-4"><a href="../../../tag/javascript.html">javascript</a></li>
                <li class="tag-4"><a href="../../../tag/firefox.html">firefox</a></li>
                <li class="tag-1"><a href="../../../tag/python.html">python</a></li>
                <li class="tag-2"><a href="../../../tag/scalability.html">scalability</a></li>
                <li class="tag-4"><a href="../../../tag/encoding.html">encoding</a></li>
                <li class="tag-4"><a href="../../../tag/pygame.html">pygame</a></li>
                <li class="tag-2"><a href="../../../tag/java.html">java</a></li>
                <li class="tag-4"><a href="../../../tag/replication.html">replication</a></li>
                <li class="tag-4"><a href="../../../tag/optimization.html">optimization</a></li>
                <li class="tag-4"><a href="../../../tag/nexus.html">nexus</a></li>
                <li class="tag-4"><a href="../../../tag/facebook graph.html">facebook graph</a></li>
                <li class="tag-2"><a href="../../../tag/android.html">android</a></li>
              </ul>
            </div>

            <div>
              <!-- Pelican's tag cloud -->
              <label>Archives</label>
              <ul class="side-nav">
                  <li>
                    <a href="/posts/2012">2012 (7)</a>
                  </li>
                  <li>
                    <a href="/posts/2013">2013 (5)</a>
                  </li>
              </ul>
            </div>

            <div>
              <label>Links</label>              
              <ul class="side-nav">

              </ul>
            </div>
          </div>
          </aside>
        </div>
        

      </section>

      <footer class="row">
        <div class="small-12 medium-9 columns">
          <hr/>
          <p class="text-center">
            Powered by <a href="http://getpelican.com">Pelican</a> and
            <a href="http://foundation.zurb.com/">Zurb Foundation</a>.
          </p>
        </div>
      </footer>

      <a class="exit-off-canvas"></a>
    </div>
  </div>
 
 
  <!-- Main Page Content and Sidebar -->
 
 

  <!-- Just before closing body tag -->
  <script src="/theme/js/vendor/jquery.js"></script> 
  <script src="/theme/js/vendor/fastclick.js"></script>
  <script src="/theme/js/foundation/foundation.min.js"></script>
  <script> $(document).foundation(); </script>  
  </body>
</html>